<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>locopy: Data Load and Copy using Python &mdash; locopy 0.5.9 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js?v=b8460c5c"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Basic Examples" href="examples.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="#" class="icon icon-home">
            locopy
          </a>
              <div class="version">
                0.5.9
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Basic Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes.html">Common Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="snowflake.html">Snowflake</a></li>
<li class="toctree-l1"><a class="reference internal" href="sql_injection.html">SQL Injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer.html">Developer Instructions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/modules.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/capitalone/locopy">Github Repo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">locopy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="#" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">locopy: Data Load and Copy using Python</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <a class="reference external image-reference" href="https://github.com/capitalone/locopy/actions"><img alt="https://github.com/capitalone/locopy/workflows/Python%20package/badge.svg" src="https://github.com/capitalone/locopy/workflows/Python%20package/badge.svg" /></a>
<a class="reference external image-reference" href="https://github.com/ambv/black"><img alt="https://img.shields.io/badge/code%20style-black-000000.svg" src="https://img.shields.io/badge/code%20style-black-000000.svg" /></a>
<section id="locopy-data-load-and-copy-using-python">
<h1>locopy: Data Load and Copy using Python<a class="headerlink" href="#locopy-data-load-and-copy-using-python" title="Permalink to this heading">¶</a></h1>
<p>A Python library to assist with ETL processing for:</p>
<ul class="simple">
<li><p>Amazon Redshift (<code class="docutils literal notranslate"><span class="pre">COPY</span></code>, <code class="docutils literal notranslate"><span class="pre">UNLOAD</span></code>)</p></li>
<li><p>Snowflake (<code class="docutils literal notranslate"><span class="pre">COPY</span> <span class="pre">INTO</span> <span class="pre">&lt;table&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">COPY</span> <span class="pre">INTO</span> <span class="pre">&lt;location&gt;</span></code>)</p></li>
</ul>
<p>In addition:</p>
<ul class="simple">
<li><p>The library supports Python 3.8 to 3.10</p></li>
<li><p>DB Driver (Adapter) agnostic. Use your favourite driver that complies with
<a class="reference external" href="https://www.python.org/dev/peps/pep-0249/">DB-API 2.0</a></p></li>
<li><p>It provides functionality to download and upload data to S3 buckets, and internal stages (Snowflake)</p></li>
</ul>
</section>
<section id="quick-installation">
<h1>Quick Installation<a class="headerlink" href="#quick-installation" title="Permalink to this heading">¶</a></h1>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>locopy
</pre></div>
</div>
<p>or install from conda-forge</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>config<span class="w"> </span>--add<span class="w"> </span>channels<span class="w"> </span>conda-forge
conda<span class="w"> </span>install<span class="w"> </span>locopy
</pre></div>
</div>
<section id="installation-instructions">
<h2>Installation instructions<a class="headerlink" href="#installation-instructions" title="Permalink to this heading">¶</a></h2>
<p>A virtual or conda environment is highly recommended</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>virtualenv<span class="w"> </span>locopy
$<span class="w"> </span><span class="nb">source</span><span class="w"> </span>locopy/bin/activate
$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>setuptools<span class="w"> </span>pip
$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>locopy
</pre></div>
</div>
</section>
<section id="python-database-api-specification-2-0">
<h2>Python Database API Specification 2.0<a class="headerlink" href="#python-database-api-specification-2-0" title="Permalink to this heading">¶</a></h2>
<p>Rather than using a specific Python DB Driver / Adapter for Postgres (which should supports Amazon
Redshift or Snowflake), <code class="docutils literal notranslate"><span class="pre">locopy</span></code> prefers to be agnostic. As an end user you can use any Python
Database API Specification 2.0 package.</p>
<p>The following packages have been tested:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">psycopg2</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pg8000</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">snowflake-connector-python</span></code></p></li>
</ul>
<p>You can use which ever one you prefer by importing the package and passing it
into the constructor input <code class="docutils literal notranslate"><span class="pre">dbapi</span></code>.</p>
</section>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this heading">¶</a></h2>
<p>You need to store your connection parameters in a YAML file (or pass them in directly).
The YAML would consist of the following items:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># required to connect to redshift</span>
<span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my.redshift.cluster.com</span>
<span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5439</span>
<span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span>
<span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">userid</span>
<span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">password</span>
<span class="c1">## optional extras for the dbapi connector</span>
<span class="nt">sslmode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">require</span>
<span class="nt">another_option</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">123</span>
</pre></div>
</div>
<p>If you aren’t loading data, you don’t need to have AWS tokens set up.
The Redshift connection (<code class="docutils literal notranslate"><span class="pre">Redshift</span></code>) can be used like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pg8000</span>
<span class="kn">import</span> <span class="nn">locopy</span>

<span class="k">with</span> <span class="n">locopy</span><span class="o">.</span><span class="n">Redshift</span><span class="p">(</span><span class="n">dbapi</span><span class="o">=</span><span class="n">pg8000</span><span class="p">,</span> <span class="n">config_yaml</span><span class="o">=</span><span class="s2">&quot;config.yml&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">redshift</span><span class="p">:</span>
    <span class="n">redshift</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM schema.table&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">redshift</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
<p>If you want to load data to Redshift via S3, the <code class="docutils literal notranslate"><span class="pre">Redshift</span></code> class inherits from <code class="docutils literal notranslate"><span class="pre">S3</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pg8000</span>
<span class="kn">import</span> <span class="nn">locopy</span>

<span class="k">with</span> <span class="n">locopy</span><span class="o">.</span><span class="n">Redshift</span><span class="p">(</span><span class="n">dbapi</span><span class="o">=</span><span class="n">pg8000</span><span class="p">,</span> <span class="n">config_yaml</span><span class="o">=</span><span class="s2">&quot;config.yml&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">redshift</span><span class="p">:</span>
    <span class="n">redshift</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET query_group TO quick&quot;</span><span class="p">)</span>
    <span class="n">redshift</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE schema.table (variable VARCHAR(20)) DISTKEY(variable)&quot;</span><span class="p">)</span>
    <span class="n">redshift</span><span class="o">.</span><span class="n">load_and_copy</span><span class="p">(</span>
        <span class="n">local_file</span><span class="o">=</span><span class="s2">&quot;example/example_data.csv&quot;</span><span class="p">,</span>
        <span class="n">s3_bucket</span><span class="o">=</span><span class="s2">&quot;my_s3_bucket&quot;</span><span class="p">,</span>
        <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;schema.table&quot;</span><span class="p">,</span>
        <span class="n">delim</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="n">redshift</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM schema.table&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">redshift</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
<p>If you want to download data from Redshift to a CSV, or read it into Python</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_profile</span> <span class="o">=</span> <span class="s2">&quot;some_profile_with_valid_tokens&quot;</span>
<span class="k">with</span> <span class="n">locopy</span><span class="o">.</span><span class="n">Redshift</span><span class="p">(</span><span class="n">dbapi</span><span class="o">=</span><span class="n">pg8000</span><span class="p">,</span> <span class="n">config_yaml</span><span class="o">=</span><span class="s2">&quot;config.yml&quot;</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">my_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">redshift</span><span class="p">:</span>
    <span class="c1">##Optionally provide export if you ALSO want the exported data copied to a flat file</span>
    <span class="n">redshift</span><span class="o">.</span><span class="n">unload_and_copy</span><span class="p">(</span>
        <span class="n">query</span><span class="o">=</span><span class="s2">&quot;SELECT * FROM schema.table&quot;</span><span class="p">,</span>
        <span class="n">s3_bucket</span><span class="o">=</span><span class="s2">&quot;my_s3_bucket&quot;</span><span class="p">,</span>
        <span class="n">export_path</span><span class="o">=</span><span class="s2">&quot;my_output_destination.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
<section id="note-on-tokens">
<h3>Note on tokens<a class="headerlink" href="#note-on-tokens" title="Permalink to this heading">¶</a></h3>
<p>To load data to S3, you will need to be able to generate AWS tokens, or assume the IAM role on a EC2
instance. There are a few options for doing this, depending on where you’re running your script and
how you want to handle tokens. Once you have your tokens, they need to be accessible to the AWS
command line interface. See
<a class="reference external" href="http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html#config-settings-and-precedence">http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html#config-settings-and-precedence</a>
for more information, but you can:</p>
<ul class="simple">
<li><p>Populate environment variables <code class="docutils literal notranslate"><span class="pre">AWS_ACCESS_KEY_ID</span></code>, <code class="docutils literal notranslate"><span class="pre">AWS_SECRET_ACCESS_KEY</span></code>,
etc.</p></li>
<li><p>Leverage the AWS credentials file.  If you have multiple profiles configured
you can either call <code class="docutils literal notranslate"><span class="pre">locopy.Redshift(profile=&quot;my-profile&quot;)</span></code>, or set up an
environment variable <code class="docutils literal notranslate"><span class="pre">AWS_DEFAULT_PROFILE</span></code>.</p></li>
<li><p>If you are on a EC2 instance you can assume the credentials associated with the IAM role attached.</p></li>
</ul>
</section>
</section>
<section id="advanced-usage">
<h2>Advanced Usage<a class="headerlink" href="#advanced-usage" title="Permalink to this heading">¶</a></h2>
<p>See the <a class="reference external" href="https://capitalone.github.io/locopy/">docs</a> for
more detailed usage instructions and examples including Snowflake.</p>
</section>
<section id="contributors">
<h2>Contributors<a class="headerlink" href="#contributors" title="Permalink to this heading">¶</a></h2>
<p>We welcome and appreciate your contributions! Before we can accept any contributions, we ask that you please be sure to
sign the <a class="reference external" href="https://cla-assistant.io/capitalone/locopy">Contributor License Agreement (CLA)</a>.</p>
<p>This project adheres to the <a class="reference external" href="https://developer.capitalone.com/resources/code-of-conduct/">Open Source Code of Conduct</a>.
By participating, you are expected to honor this code.</p>
</section>
<section id="roadmap">
<h2>Roadmap<a class="headerlink" href="#roadmap" title="Permalink to this heading">¶</a></h2>
<p>Roadmap details can be found <a class="reference external" href="https://github.com/capitalone/locopy/blob/develop/ROADMAP.rst">here</a></p>
<div class="toctree-wrapper compound">
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Basic Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="examples.html#upload-to-s3-and-run-copy-command-with-yaml">Upload to S3 and run COPY command with YAML</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#upload-to-s3-and-run-copy-command-without-yaml">Upload to S3 and run COPY command without YAML</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#aws-tokens-as-environment-variables">AWS tokens as environment variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#extra-parameters-on-the-copy-job">Extra parameters on the COPY job</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="recipes.html">Common Recipes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="recipes.html#i-have-a-file-i-want-to-load-to-redshift">I have a file I want to load to Redshift</a></li>
<li class="toctree-l2"><a class="reference internal" href="recipes.html#i-d-like-to-split-my-file-into-n-files">I’d like to split my file into <em>n</em> files</a></li>
<li class="toctree-l2"><a class="reference internal" href="recipes.html#i-don-t-want-to-compress-my-files">I don’t want to compress my files</a></li>
<li class="toctree-l2"><a class="reference internal" href="recipes.html#i-want-to-export-some-data-from-redshift-to-a-local-csv">I want to export some data from Redshift to a local CSV</a></li>
<li class="toctree-l2"><a class="reference internal" href="recipes.html#i-want-to-backup-my-table-to-s3">I want to backup my table to S3</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="snowflake.html">Snowflake</a><ul>
<li class="toctree-l2"><a class="reference internal" href="snowflake.html#upload-to-internal-stage-and-run-copy-into-table-command-with-yaml">Upload to internal stage and run COPY into table command with YAML</a></li>
<li class="toctree-l2"><a class="reference internal" href="snowflake.html#run-copy-command-without-yaml">Run COPY command without YAML</a></li>
<li class="toctree-l2"><a class="reference internal" href="snowflake.html#aws-tokens-as-environment-variables">AWS tokens as environment variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="snowflake.html#extra-parameters-on-the-copy-job">Extra parameters on the COPY job</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="sql_injection.html">SQL Injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer.html">Developer Instructions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="developer.html#pre-commit-hooks">Pre-Commit Hooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer.html#generating-documentation">Generating Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer.html#run-unit-tests">Run unit tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer.html#integration-tests">Integration Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer.html#management-of-requirements">Management of Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer.html#edgetest">edgetest</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer.html#release-guide">Release Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer.html#generating-distribution-archives-pypi">Generating distribution archives (PyPI)</a></li>
</ul>
</li>
</ul>
</div>
<div class="toctree-wrapper compound">
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/modules.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api/locopy.html">locopy package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api/locopy.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="api/locopy.database.html">locopy.database module</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/locopy.errors.html">locopy.errors module</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/locopy.logger.html">locopy.logger module</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/locopy.redshift.html">locopy.redshift module</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/locopy.s3.html">locopy.s3 module</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/locopy.snowflake.html">locopy.snowflake module</a></li>
<li class="toctree-l4"><a class="reference internal" href="api/locopy.utility.html">locopy.utility module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="api/locopy.html#module-locopy">Module contents</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/capitalone/locopy">Github Repo</a></li>
</ul>
</div>
</section>
</section>
<section id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
</ul>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="examples.html" class="btn btn-neutral float-right" title="Basic Examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, Capital One Services, LLC.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>