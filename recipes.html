<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Common Recipes &mdash; locopy 0.6.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/documentation_options.js?v=2bd037f0"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Snowflake Examples" href="snowflake.html" />
    <link rel="prev" title="Basic Examples" href="examples.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            locopy
          </a>
              <div class="version">
                0.6.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="examples.html">Basic Examples</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Common Recipes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#i-have-a-file-i-want-to-load-to-redshift">I have a file I want to load to Redshift</a></li>
<li class="toctree-l2"><a class="reference internal" href="#i-d-like-to-split-my-file-into-n-files">I’d like to split my file into <em>n</em> files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#i-don-t-want-to-compress-my-files">I don’t want to compress my files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#i-want-to-export-some-data-from-redshift-to-a-local-csv">I want to export some data from Redshift to a local CSV</a></li>
<li class="toctree-l2"><a class="reference internal" href="#i-want-to-backup-my-table-to-s3">I want to backup my table to S3</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="snowflake.html">Snowflake</a></li>
<li class="toctree-l1"><a class="reference internal" href="sql_injection.html">SQL Injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer.html">Developer Instructions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/modules.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/capitalone/locopy">Github Repo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">locopy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Common Recipes</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/recipes.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="common-recipes">
<h1>Common Recipes<a class="headerlink" href="#common-recipes" title="Link to this heading">¶</a></h1>
<p>Lets go over some common use cases people will have when interacting with
<code class="docutils literal notranslate"><span class="pre">locopy</span></code>.</p>
<section id="i-have-a-file-i-want-to-load-to-redshift">
<h2>I have a file I want to load to Redshift<a class="headerlink" href="#i-have-a-file-i-want-to-load-to-redshift" title="Link to this heading">¶</a></h2>
<p>This is probably the most common use case. What you need to start:</p>
<ul class="simple">
<li><p>Read/Write S3 access</p></li>
<li><p>Read/Write Redshift Access</p></li>
</ul>
<p>There are a couple of ways you can authenticate with Redshift. If you are running
this process on a regular basis it might make sense to use a <code class="docutils literal notranslate"><span class="pre">YAML</span></code> file to
store (in a secure place) most of the details. You will also need valid AWS
tokens in order to access the appropriate AWS resources (S3 bucket).</p>
<p>Assuming you have your <code class="docutils literal notranslate"><span class="pre">YAML</span></code> file setup, the following will occur:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pg8000</span>
<span class="kn">import</span> <span class="nn">locopy</span>

<span class="k">with</span> <span class="n">locopy</span><span class="o">.</span><span class="n">Redshift</span><span class="p">(</span><span class="n">dbapi</span><span class="o">=</span><span class="n">pg8000</span><span class="p">,</span> <span class="n">config_yaml</span><span class="o">=</span><span class="s2">&quot;example.yaml&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">redshift</span><span class="p">:</span>
    <span class="n">redshift</span><span class="o">.</span><span class="n">load_and_copy</span><span class="p">(</span>
        <span class="n">local_file</span><span class="o">=</span><span class="s2">&quot;some_data_to_load.txt&quot;</span><span class="p">,</span>
        <span class="n">s3_bucket</span><span class="o">=</span><span class="s2">&quot;s3_bucket_to_use&quot;</span><span class="p">,</span>
        <span class="n">s3_folder</span><span class="o">=</span><span class="s2">&quot;s3_folder_to_use/s3_subfolder_to_use&quot;</span><span class="p">,</span>
        <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;redshift_table_to_load&quot;</span><span class="p">,</span>
        <span class="n">delim</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">some_data_to_load.txt</span></code> will be compressed (gzip) and the original file deleted</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">some_data_to_load.txt</span></code> will be uploaded to the S3 bucket:
<code class="docutils literal notranslate"><span class="pre">s3_bucket_to_use</span></code> at the location of <code class="docutils literal notranslate"><span class="pre">s3_folder_to_use/s3_subfolder_to_use</span></code></p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">COPY</span></code> command will be executed to load the contents of
<code class="docutils literal notranslate"><span class="pre">some_data_to_load.txt</span></code> to <code class="docutils literal notranslate"><span class="pre">redshift_table_to_load</span></code> using the delimiter <code class="docutils literal notranslate"><span class="pre">,</span></code></p></li>
</ul>
</section>
<section id="i-d-like-to-split-my-file-into-n-files">
<h2>I’d like to split my file into <em>n</em> files<a class="headerlink" href="#i-d-like-to-split-my-file-into-n-files" title="Link to this heading">¶</a></h2>
<p>You can tweak the above code to include the <code class="docutils literal notranslate"><span class="pre">splits</span></code> option which takes an
integer</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pg8000</span>
<span class="kn">import</span> <span class="nn">locopy</span>

<span class="k">with</span> <span class="n">locopy</span><span class="o">.</span><span class="n">Redshift</span><span class="p">(</span><span class="n">dbapi</span><span class="o">=</span><span class="n">pg8000</span><span class="p">,</span> <span class="n">config_yaml</span><span class="o">=</span><span class="s2">&quot;example.yaml&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">redshift</span><span class="p">:</span>
    <span class="n">redshift</span><span class="o">.</span><span class="n">load_and_copy</span><span class="p">(</span>
        <span class="n">local_file</span><span class="o">=</span><span class="s2">&quot;some_data_to_load.txt&quot;</span><span class="p">,</span>
        <span class="n">s3_bucket</span><span class="o">=</span><span class="s2">&quot;s3_bucket_to_use&quot;</span><span class="p">,</span>
        <span class="n">s3_folder</span><span class="o">=</span><span class="s2">&quot;s3_folder_to_use/s3_subfolder_to_use&quot;</span><span class="p">,</span>
        <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;redshift_table_to_load&quot;</span><span class="p">,</span>
        <span class="n">delim</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>
        <span class="n">splits</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">splits</span></code> is really useful when you have a <strong>very large</strong> file you want to load.
Ideally this number will equal the number of slices available to you on the
Redshift cluster.</p>
</section>
<section id="i-don-t-want-to-compress-my-files">
<h2>I don’t want to compress my files<a class="headerlink" href="#i-don-t-want-to-compress-my-files" title="Link to this heading">¶</a></h2>
<p>By default compression is always on. If you’d like to turn if off you can set
<code class="docutils literal notranslate"><span class="pre">compress=False</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pg8000</span>
<span class="kn">import</span> <span class="nn">locopy</span>

<span class="k">with</span> <span class="n">locopy</span><span class="o">.</span><span class="n">Redshift</span><span class="p">(</span><span class="n">dbapi</span><span class="o">=</span><span class="n">pg8000</span><span class="p">,</span> <span class="n">config_yaml</span><span class="o">=</span><span class="s2">&quot;example.yaml&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">redshift</span><span class="p">:</span>
    <span class="n">redshift</span><span class="o">.</span><span class="n">load_and_copy</span><span class="p">(</span>
        <span class="n">local_file</span><span class="o">=</span><span class="s2">&quot;some_data_to_load.txt&quot;</span><span class="p">,</span>
        <span class="n">s3_bucket</span><span class="o">=</span><span class="s2">&quot;s3_bucket_to_use&quot;</span><span class="p">,</span>
        <span class="n">s3_folder</span><span class="o">=</span><span class="s2">&quot;s3_folder_to_use/s3_subfolder_to_use&quot;</span><span class="p">,</span>
        <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;redshift_table_to_load&quot;</span><span class="p">,</span>
        <span class="n">delim</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>
        <span class="n">compress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Depending on your own requirements it might make sense to turn off compression
or leave it on. Combining this with <code class="docutils literal notranslate"><span class="pre">splits</span></code> can drastically alter the
performance of the <code class="docutils literal notranslate"><span class="pre">COPY</span></code> command</p>
</section>
<section id="i-want-to-export-some-data-from-redshift-to-a-local-csv">
<h2>I want to export some data from Redshift to a local CSV<a class="headerlink" href="#i-want-to-export-some-data-from-redshift-to-a-local-csv" title="Link to this heading">¶</a></h2>
<p>Data can be exported from Redshift to a CSV by supplying an <code class="docutils literal notranslate"><span class="pre">export_path</span></code>
to <code class="docutils literal notranslate"><span class="pre">locopy.Redshift.unload_and_copy()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pg8000</span>
<span class="kn">import</span> <span class="nn">locopy</span>

<span class="n">my_profile</span> <span class="o">=</span> <span class="s2">&quot;some_profile_with_valid_tokens&quot;</span>
<span class="k">with</span> <span class="n">locopy</span><span class="o">.</span><span class="n">Redshift</span><span class="p">(</span><span class="n">dbapi</span><span class="o">=</span><span class="n">pg8000</span><span class="p">,</span> <span class="n">config_yaml</span><span class="o">=</span><span class="s2">&quot;config.yml&quot;</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">my_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">redshift</span><span class="p">:</span>
    <span class="n">redshift</span><span class="o">.</span><span class="n">unload_and_copy</span><span class="p">(</span>
        <span class="n">query</span><span class="o">=</span><span class="s2">&quot;SELECT * FROM schema.table&quot;</span><span class="p">,</span>
        <span class="n">s3_bucket</span><span class="o">=</span><span class="s2">&quot;s3_bucket_to_use&quot;</span><span class="p">,</span>
        <span class="n">export_path</span><span class="o">=</span><span class="s2">&quot;output.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Or a pipe delimited….</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">locopy</span><span class="o">.</span><span class="n">Redshift</span><span class="p">(</span><span class="n">config_yaml</span><span class="o">=</span><span class="s2">&quot;config.yml&quot;</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">my_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">redshift</span><span class="p">:</span>
    <span class="n">redshift</span><span class="o">.</span><span class="n">unload_and_copy</span><span class="p">(</span>
        <span class="n">query</span><span class="o">=</span><span class="s2">&quot;SELECT * FROM schema.table&quot;</span><span class="p">,</span>
        <span class="n">s3_bucket</span><span class="o">=</span><span class="s2">&quot;s3_bucket_to_use&quot;</span><span class="p">,</span>
        <span class="n">export_path</span><span class="o">=</span><span class="s2">&quot;output.tsv&quot;</span><span class="p">,</span>
        <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If your bucket has previously unloaded files, you may get an
error when unloading. If you don’t want to delete the older files, you can
unload your data to a new folder or with a different prefix by specifying the
<code class="docutils literal notranslate"><span class="pre">s3_folder</span></code> parameter. You can specify a folder to write to, i.e.
<code class="docutils literal notranslate"><span class="pre">s3_folder=s3_folder_to_use/</span></code>, or create a unique filename prefix name by
omitting the last <code class="docutils literal notranslate"><span class="pre">/</span></code>, i.e. <code class="docutils literal notranslate"><span class="pre">s3_folder=unique_file_prefix</span></code>.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">locopy</span><span class="o">.</span><span class="n">Redshift</span><span class="p">(</span><span class="n">dbapi</span><span class="o">=</span><span class="n">pg8000</span><span class="p">,</span> <span class="n">config_yaml</span><span class="o">=</span><span class="s2">&quot;config.yml&quot;</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">my_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">redshift</span><span class="p">:</span>
    <span class="n">redshift</span><span class="o">.</span><span class="n">unload_and_copy</span><span class="p">(</span>
        <span class="n">query</span><span class="o">=</span><span class="s2">&quot;SELECT * FROM schema.table&quot;</span><span class="p">,</span>
        <span class="n">s3_bucket</span><span class="o">=</span><span class="s2">&quot;s3_bucket_to_use&quot;</span><span class="p">,</span>
        <span class="n">s3_folder</span><span class="o">=</span><span class="s2">&quot;s3_folder_to_use/&quot;</span><span class="p">,</span>
        <span class="n">export_path</span><span class="o">=</span><span class="s2">&quot;output.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="i-want-to-backup-my-table-to-s3">
<h2>I want to backup my table to S3<a class="headerlink" href="#i-want-to-backup-my-table-to-s3" title="Link to this heading">¶</a></h2>
<p>To simply export data to S3 and do nothing else, omit the <code class="docutils literal notranslate"><span class="pre">export_path</span></code> option
so that the file is not downloaded, and set <code class="docutils literal notranslate"><span class="pre">delete_s3_after=False</span></code> to prevent
the S3 files from being automatically deleted after the run.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pg8000</span>
<span class="kn">import</span> <span class="nn">locopy</span>

<span class="k">with</span> <span class="n">locopy</span><span class="o">.</span><span class="n">Redshift</span><span class="p">(</span><span class="n">dbapi</span><span class="o">=</span><span class="n">pg8000</span><span class="p">,</span> <span class="n">config_yaml</span><span class="o">=</span><span class="s2">&quot;config.yml&quot;</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">my_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">redshift</span><span class="p">:</span>
    <span class="n">redshift</span><span class="o">.</span><span class="n">unload_and_copy</span><span class="p">(</span>
        <span class="n">query</span><span class="o">=</span><span class="s2">&quot;SELECT * FROM schema.table&quot;</span><span class="p">,</span>
        <span class="n">s3_bucket</span><span class="o">=</span><span class="s2">&quot;s3_bucket_to_use&quot;</span><span class="p">,</span>
        <span class="n">s3_folder</span><span class="o">=</span><span class="s2">&quot;s3_folder_to_use/s3_subfolder_to_use/&quot;</span><span class="p">,</span>
        <span class="n">delete_s3_after</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># defaults to True</span>
</pre></div>
</div>
<p>By default, the Redshift unloads data to multiple files in S3 for performance
reasons. The maximum size for a data file is 6.2 GB. If the data size is
greater than the maximum, UNLOAD creates additional files, up to 6.2 GB each.
If you want to back it up as a single file, you can run:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">locopy</span><span class="o">.</span><span class="n">Redshift</span><span class="p">(</span><span class="n">dbapi</span><span class="o">=</span><span class="n">pg8000</span><span class="p">,</span> <span class="n">config_yaml</span><span class="o">=</span><span class="s2">&quot;config.yml&quot;</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">my_profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">redshift</span><span class="p">:</span>
    <span class="n">redshift</span><span class="o">.</span><span class="n">unload_and_copy</span><span class="p">(</span>
        <span class="n">query</span><span class="o">=</span><span class="s2">&quot;SELECT * FROM schema.table&quot;</span><span class="p">,</span>
        <span class="n">s3_bucket</span><span class="o">=</span><span class="s2">&quot;s3_bucket_to_use&quot;</span><span class="p">,</span>
        <span class="n">s3_folder</span><span class="o">=</span><span class="s2">&quot;s3_folder_to_use/s3_subfolder_to_use/&quot;</span><span class="p">,</span>
        <span class="n">delete_s3_after</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">parallel_off</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="examples.html" class="btn btn-neutral float-left" title="Basic Examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="snowflake.html" class="btn btn-neutral float-right" title="Snowflake Examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, Capital One Services, LLC.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>