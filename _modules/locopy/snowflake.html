

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>locopy.snowflake &mdash; locopy 0.6.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/documentation_options.js?v=b8503983"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            locopy
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Basic Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../recipes.html">Common Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snowflake.html">Snowflake</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql_injection.html">SQL Injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer.html">Developer Instructions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/capitalone/locopy">Github Repo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">locopy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">locopy.snowflake</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for locopy.snowflake</h1><div class="highlight"><pre>
<span></span><span class="c1"># SPDX-Copyright: Copyright (c) Capital One Services, LLC</span>
<span class="c1"># SPDX-License-Identifier: Apache-2.0</span>
<span class="c1"># Copyright 2018 Capital One Services, LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Snowflake Module.</span>

<span class="sd">Module to wrap a database adapter into a Snowflake class which can be used to connect</span>
<span class="sd">to Snowflake, and run arbitrary code.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">singledispatch</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">PurePath</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">polars</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">polars.selectors</span> <span class="k">as</span> <span class="nn">cs</span>

<span class="kn">from</span> <span class="nn">locopy.database</span> <span class="kn">import</span> <span class="n">Database</span>
<span class="kn">from</span> <span class="nn">locopy.errors</span> <span class="kn">import</span> <span class="n">DBError</span><span class="p">,</span> <span class="n">S3CredentialsError</span>
<span class="kn">from</span> <span class="nn">locopy.logger</span> <span class="kn">import</span> <span class="n">INFO</span><span class="p">,</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">locopy.s3</span> <span class="kn">import</span> <span class="n">S3</span>
<span class="kn">from</span> <span class="nn">locopy.utility</span> <span class="kn">import</span> <span class="n">find_column_type</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">INFO</span><span class="p">)</span>

<span class="n">COPY_FORMAT_OPTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;csv&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;compression&quot;</span><span class="p">,</span>
        <span class="s2">&quot;record_delimiter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;field_delimiter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;skip_header&quot;</span><span class="p">,</span>
        <span class="s2">&quot;date_format&quot;</span><span class="p">,</span>
        <span class="s2">&quot;time_format&quot;</span><span class="p">,</span>
        <span class="s2">&quot;timestamp_format&quot;</span><span class="p">,</span>
        <span class="s2">&quot;binary_format&quot;</span><span class="p">,</span>
        <span class="s2">&quot;escape&quot;</span><span class="p">,</span>
        <span class="s2">&quot;escape_unenclosed_field&quot;</span><span class="p">,</span>
        <span class="s2">&quot;trim_space&quot;</span><span class="p">,</span>
        <span class="s2">&quot;field_optionally_enclosed_by&quot;</span><span class="p">,</span>
        <span class="s2">&quot;null_if&quot;</span><span class="p">,</span>
        <span class="s2">&quot;error_on_column_count_mismatch&quot;</span><span class="p">,</span>
        <span class="s2">&quot;validate_utf8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;empty_field_as_null&quot;</span><span class="p">,</span>
        <span class="s2">&quot;skip_byte_order_mark&quot;</span><span class="p">,</span>
        <span class="s2">&quot;encoding&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;json&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;compression&quot;</span><span class="p">,</span>
        <span class="s2">&quot;file_extension&quot;</span><span class="p">,</span>
        <span class="s2">&quot;enable_octal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;allow_duplicate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;strip_outer_array&quot;</span><span class="p">,</span>
        <span class="s2">&quot;strip_null_values&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ignore_utf8_errors&quot;</span><span class="p">,</span>
        <span class="s2">&quot;skip_byte_order_mark&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;parquet&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;binary_as_text&quot;</span><span class="p">},</span>
<span class="p">}</span>


<span class="n">UNLOAD_FORMAT_OPTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;csv&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;compression&quot;</span><span class="p">,</span>
        <span class="s2">&quot;record_delimiter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;field_delimiter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;file_extension&quot;</span><span class="p">,</span>
        <span class="s2">&quot;date_format&quot;</span><span class="p">,</span>
        <span class="s2">&quot;time_format&quot;</span><span class="p">,</span>
        <span class="s2">&quot;timestamp_format&quot;</span><span class="p">,</span>
        <span class="s2">&quot;binary_format&quot;</span><span class="p">,</span>
        <span class="s2">&quot;escape&quot;</span><span class="p">,</span>
        <span class="s2">&quot;escape_unenclosed_field&quot;</span><span class="p">,</span>
        <span class="s2">&quot;field_optionally_enclosed_by&quot;</span><span class="p">,</span>
        <span class="s2">&quot;null_if&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;json&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;compression&quot;</span><span class="p">,</span> <span class="s2">&quot;file_extension&quot;</span><span class="p">},</span>
    <span class="s2">&quot;parquet&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;snappy_compression&quot;</span><span class="p">},</span>
<span class="p">}</span>


<div class="viewcode-block" id="combine_options">
<a class="viewcode-back" href="../../api/locopy.snowflake.html#locopy.combine_options">[docs]</a>
<span class="k">def</span> <span class="nf">combine_options</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the ``copy_options`` or ``format_options`` attribute.</span>

<span class="sd">    With spaces in between and as a string. If options is ``None`` then return an empty string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    options : list, optional</span>
<span class="sd">        list of strings which is to be converted into a single string with spaces</span>
<span class="sd">        inbetween. Defaults to ``None``</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str:</span>
<span class="sd">        ``options`` attribute with spaces in between</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span></div>



<div class="viewcode-block" id="Snowflake">
<a class="viewcode-back" href="../../api/locopy.snowflake.html#locopy.Snowflake">[docs]</a>
<span class="k">class</span> <span class="nc">Snowflake</span><span class="p">(</span><span class="n">S3</span><span class="p">,</span> <span class="n">Database</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Locopy class which manages connections to Snowflake.  Inherits ``Database``.</span>

<span class="sd">    Implements the specific ``COPY INTO`` functionality.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    profile : str, optional</span>
<span class="sd">        The name of the AWS profile to use which is typically stored in the</span>
<span class="sd">        ``credentials`` file.  You can also set environment variable</span>
<span class="sd">        ``AWS_DEFAULT_PROFILE`` which would be used instead.</span>

<span class="sd">    kms_key : str, optional</span>
<span class="sd">        The KMS key to use for encryption</span>
<span class="sd">        If kms_key Defaults to ``None`` then the AES256 ServerSideEncryption</span>
<span class="sd">        will be used.</span>

<span class="sd">    dbapi : DBAPI 2 module, optional</span>
<span class="sd">        A database adapter which is Python DB API 2.0 compliant (``snowflake.connector``)</span>

<span class="sd">    config_yaml : str, optional</span>
<span class="sd">        String representing the YAML file location of the database connection keyword arguments. It</span>
<span class="sd">        is worth noting that this should only contain valid arguments for the database connector you</span>
<span class="sd">        plan on using. It will throw an exception if something is passed through which isn&#39;t valid.</span>

<span class="sd">    **kwargs</span>
<span class="sd">        Database connection keyword arguments.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    profile : str</span>
<span class="sd">        String representing the AWS profile for authentication</span>

<span class="sd">    kms_key : str</span>
<span class="sd">        String representing the s3 kms key</span>

<span class="sd">    session : boto3.Session</span>
<span class="sd">        Hold the AWS session credentials / info</span>

<span class="sd">    s3 : botocore.client.S3</span>
<span class="sd">        Hold the S3 client object which is used to upload/delete files to S3</span>

<span class="sd">    dbapi : DBAPI 2 module</span>
<span class="sd">        database adapter which is Python DBAPI 2.0 compliant (snowflake.connector)</span>

<span class="sd">    connection : dict</span>
<span class="sd">        Dictionary of database connection items</span>

<span class="sd">    conn : dbapi.connection</span>
<span class="sd">        DBAPI connection instance</span>

<span class="sd">    cursor : dbapi.cursor</span>
<span class="sd">        DBAPI cursor instance</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    CredentialsError</span>
<span class="sd">        Database credentials are not provided or valid</span>

<span class="sd">    S3Error</span>
<span class="sd">        Error initializing AWS Session (ex: invalid profile)</span>

<span class="sd">    S3CredentialsError</span>
<span class="sd">        Issue with AWS credentials</span>

<span class="sd">    S3InitializationError</span>
<span class="sd">        Issue initializing S3 session</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kms_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbapi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config_yaml</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">S3</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">kms_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">S3CredentialsError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;S3 credentials were not found. S3 functionality is disabled&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Only internal stages are available&quot;</span><span class="p">)</span>
        <span class="n">Database</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbapi</span><span class="p">,</span> <span class="n">config_yaml</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="Snowflake.connect">
<a class="viewcode-back" href="../../api/locopy.snowflake.html#locopy.Snowflake.connect">[docs]</a>
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a connection to the Snowflake cluster.</span>

<span class="sd">        Setg the values of the ``conn`` and ``cursor`` attributes.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        DBError</span>
<span class="sd">            If there is a problem establishing a connection to Snowflake.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;warehouse&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;USE WAREHOUSE </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">[</span><span class="s2">&quot;warehouse&quot;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;database&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;USE DATABASE </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;USE SCHEMA </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]))</span></div>


<div class="viewcode-block" id="Snowflake.upload_to_internal">
<a class="viewcode-back" href="../../api/locopy.snowflake.html#locopy.Snowflake.upload_to_internal">[docs]</a>
    <span class="k">def</span> <span class="nf">upload_to_internal</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">auto_compress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upload file(s) to a internal stage via the ``PUT`` command.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        local : str</span>
<span class="sd">            The local directory path to the file to upload. Wildcard characters (``*``, ``?``) are</span>
<span class="sd">            supported to enable uploading multiple files in a directory. Otherwise it must be the</span>
<span class="sd">            absolute path.</span>

<span class="sd">        stage : str</span>
<span class="sd">            Internal stage location to load the file.</span>

<span class="sd">        parallel : int, optional</span>
<span class="sd">            Specifies the number of threads to use for uploading files.</span>

<span class="sd">        auto_compress : bool, optional</span>
<span class="sd">            Specifies if Snowflake uses gzip to compress files during upload.</span>
<span class="sd">            If ``True``, the files are compressed (if they are not already compressed).</span>
<span class="sd">            if ``False``, the files are uploaded as-is.</span>

<span class="sd">        overwrite : bool, optional</span>
<span class="sd">            Specifies whether Snowflake overwrites an existing file with the same name during upload.</span>
<span class="sd">            If ``True``, existing file with the same name is overwritten.</span>
<span class="sd">            if ``False``, existing file with the same name is not overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">local_uri</span> <span class="o">=</span> <span class="n">PurePath</span><span class="p">(</span><span class="n">local</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;PUT &#39;file://</span><span class="si">{</span><span class="n">local_uri</span><span class="si">}</span><span class="s2">&#39; </span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2"> PARALLEL=</span><span class="si">{</span><span class="n">parallel</span><span class="si">}</span><span class="s2"> AUTO_COMPRESS=</span><span class="si">{</span><span class="n">auto_compress</span><span class="si">}</span><span class="s2"> OVERWRITE=</span><span class="si">{</span><span class="n">overwrite</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Snowflake.download_from_internal">
<a class="viewcode-back" href="../../api/locopy.snowflake.html#locopy.Snowflake.download_from_internal">[docs]</a>
    <span class="k">def</span> <span class="nf">download_from_internal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download file(s) from a internal stage via the ``GET`` command.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stage : str</span>
<span class="sd">            Internal stage location to load the file.</span>

<span class="sd">        local : str, optional</span>
<span class="sd">            The local directory path where files will be downloaded to. Defualts to the current</span>
<span class="sd">            working directory (``os.getcwd()``). Otherwise it must be the absolute path.</span>

<span class="sd">        parallel : int, optional</span>
<span class="sd">            Specifies the number of threads to use for downloading files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">local</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">local_uri</span> <span class="o">=</span> <span class="n">PurePath</span><span class="p">(</span><span class="n">local</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GET </span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2"> &#39;file://</span><span class="si">{</span><span class="n">local_uri</span><span class="si">}</span><span class="s2">&#39; PARALLEL=</span><span class="si">{</span><span class="n">parallel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Snowflake.copy">
<a class="viewcode-back" href="../../api/locopy.snowflake.html#locopy.Snowflake.copy">[docs]</a>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="n">format_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copy_options</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load files from a stage into a Snowflake table.</span>

<span class="sd">        Execute the ``COPY INTO &lt;table&gt;`` command to  If ``file_type == csv`` and ``format_options == None``, ``format_options``</span>
<span class="sd">        will default to: ``[&quot;FIELD_DELIMITER=&#39;|&#39;&quot;, &quot;SKIP_HEADER=0&quot;]``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        table_name : str</span>
<span class="sd">            The Snowflake table name which is being loaded. Must be fully qualified:</span>
<span class="sd">            `&lt;namespace&gt;.&lt;table_name&gt;`</span>

<span class="sd">        stage : str</span>
<span class="sd">            Stage location of the load file. This can be a internal or external stage</span>

<span class="sd">        file_type : str</span>
<span class="sd">            The file type. One of ``csv``, ``json``, or ``parquet``</span>

<span class="sd">        format_options : list</span>
<span class="sd">            List of strings of format options to provide to the ``COPY INTO`` command. The options</span>
<span class="sd">            will typically be in the format of ``[&quot;a=b&quot;, &quot;c=d&quot;]``</span>

<span class="sd">        copy_options : list</span>
<span class="sd">            List of strings of copy options to provide to the ``COPY INTO`` command.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        DBError</span>
<span class="sd">            If there is a problem executing the COPY command, or a connection</span>
<span class="sd">            has not been initalized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_connected</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">DBError</span><span class="p">(</span><span class="s2">&quot;No Snowflake connection object is present.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">file_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">COPY_FORMAT_OPTIONS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid file_type. Must be one of </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">COPY_FORMAT_OPTIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">format_options</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">format_options</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FIELD_DELIMITER=&#39;|&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;SKIP_HEADER=0&quot;</span><span class="p">]</span>

        <span class="n">format_options_text</span> <span class="o">=</span> <span class="n">combine_options</span><span class="p">(</span><span class="n">format_options</span><span class="p">)</span>
        <span class="n">copy_options_text</span> <span class="o">=</span> <span class="n">combine_options</span><span class="p">(</span><span class="n">copy_options</span><span class="p">)</span>
        <span class="n">base_copy_string</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;COPY INTO </span><span class="si">{0}</span><span class="s2"> FROM &#39;</span><span class="si">{1}</span><span class="s2">&#39; &quot;</span> <span class="s2">&quot;FILE_FORMAT = (TYPE=&#39;</span><span class="si">{2}</span><span class="s2">&#39; </span><span class="si">{3}</span><span class="s2">) </span><span class="si">{4}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">base_copy_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">table_name</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">file_type</span><span class="p">,</span> <span class="n">format_options_text</span><span class="p">,</span> <span class="n">copy_options_text</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error running COPY on Snowflake. err: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">DBError</span><span class="p">(</span><span class="s2">&quot;Error running COPY on Snowflake.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span></div>


<div class="viewcode-block" id="Snowflake.unload">
<a class="viewcode-back" href="../../api/locopy.snowflake.html#locopy.Snowflake.unload">[docs]</a>
    <span class="k">def</span> <span class="nf">unload</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stage</span><span class="p">,</span>
        <span class="n">table_name</span><span class="p">,</span>
        <span class="n">file_type</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span>
        <span class="n">format_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">copy_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export a query/table from Snowflake to a stage.</span>

<span class="sd">        Execute the ``COPY INTO &lt;location&gt;`` command.</span>

<span class="sd">        If ``file_type == csv`` and ``format_options == None``, ``format_options``</span>
<span class="sd">        will default to: ``[&quot;FIELD_DELIMITER=&#39;|&#39;&quot;]``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stage : str</span>
<span class="sd">            Stage location (internal or external) where the data files are unloaded</span>

<span class="sd">        table_name : str</span>
<span class="sd">            The Snowflake table name which is being unloaded. Must be fully qualified:</span>
<span class="sd">            ``&lt;namespace&gt;.&lt;table_name&gt;``</span>

<span class="sd">        file_type : str</span>
<span class="sd">            The file type. One of ``csv``, ``json``, or ``parquet``</span>

<span class="sd">        format_options : list</span>
<span class="sd">            List of strings of format options to provide to the ``COPY INTO`` command.</span>

<span class="sd">        header : bool, optional</span>
<span class="sd">            Boolean flag if header is included in the file(s)</span>

<span class="sd">        copy_options : list</span>
<span class="sd">            List of strings of copy options to provide to the ``COPY INTO`` command.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        DBError</span>
<span class="sd">            If there is a problem executing the UNLOAD command, or a connection</span>
<span class="sd">            has not been initalized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_connected</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">DBError</span><span class="p">(</span><span class="s2">&quot;No Snowflake connection object is present&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">file_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">COPY_FORMAT_OPTIONS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid file_type. Must be one of </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">UNLOAD_FORMAT_OPTIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">format_options</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">format_options</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FIELD_DELIMITER=&#39;|&#39;&quot;</span><span class="p">]</span>

        <span class="n">format_options_text</span> <span class="o">=</span> <span class="n">combine_options</span><span class="p">(</span><span class="n">format_options</span><span class="p">)</span>
        <span class="n">copy_options_text</span> <span class="o">=</span> <span class="n">combine_options</span><span class="p">(</span><span class="n">copy_options</span><span class="p">)</span>
        <span class="n">base_unload_string</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;COPY INTO </span><span class="si">{0}</span><span class="s2"> FROM </span><span class="si">{1}</span><span class="s2"> &quot;</span> <span class="s2">&quot;FILE_FORMAT = (TYPE=&#39;</span><span class="si">{2}</span><span class="s2">&#39; </span><span class="si">{3}</span><span class="s2">) HEADER=</span><span class="si">{4}</span><span class="s2"> </span><span class="si">{5}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">base_unload_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">stage</span><span class="p">,</span>
                <span class="n">table_name</span><span class="p">,</span>
                <span class="n">file_type</span><span class="p">,</span>
                <span class="n">format_options_text</span><span class="p">,</span>
                <span class="n">header</span><span class="p">,</span>
                <span class="n">copy_options_text</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error running UNLOAD on Snowflake. err: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">DBError</span><span class="p">(</span><span class="s2">&quot;Error running UNLOAD on Snowflake.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span></div>


<div class="viewcode-block" id="Snowflake.insert_dataframe_to_table">
<a class="viewcode-back" href="../../api/locopy.snowflake.html#locopy.Snowflake.insert_dataframe_to_table">[docs]</a>
    <span class="k">def</span> <span class="nf">insert_dataframe_to_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert a Pandas or Polars dataframe to an existing table or a new table.</span>

<span class="sd">        In newer versions of the</span>
<span class="sd">        python snowflake connector (v2.1.2+) users can call the ``write_pandas`` method from the cursor</span>
<span class="sd">        directly, ``insert_dataframe_to_table`` is a custom implementation and does not use</span>
<span class="sd">        ``write_pandas``. Instead of using ``COPY INTO`` the method builds a list of tuples to</span>
<span class="sd">        insert directly into the table. There are also options to create the table if it doesn&#39;t</span>
<span class="sd">        exist and use your own metadata. If your data is significantly large then using</span>
<span class="sd">        ``COPY INTO &lt;table&gt;`` is more appropriate.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dataframe: Pandas or Polars Dataframe</span>
<span class="sd">            The pandas or polars dataframe which needs to be inserted.</span>

<span class="sd">        table_name: str</span>
<span class="sd">            The name of the Snowflake table which is being inserted.</span>

<span class="sd">        columns: list, optional</span>
<span class="sd">            The list of columns which will be uploaded.</span>

<span class="sd">        create: bool, optional</span>
<span class="sd">            Boolean flag if a new table need to be created and insert to.</span>

<span class="sd">        metadata: dictionary, optional</span>
<span class="sd">            If metadata==None, it will be generated based on data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">dataframe</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>

        <span class="n">all_columns</span> <span class="o">=</span> <span class="n">columns</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">column_sql</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_columns</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="n">string_join</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_columns</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>

        <span class="c1"># create a list of tuples for insert</span>
        <span class="nd">@singledispatch</span>
        <span class="k">def</span> <span class="nf">get_insert_tuple</span><span class="p">(</span><span class="n">dataframe</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Create a list of tuples for insert.&quot;&quot;&quot;</span>
            <span class="k">pass</span>

        <span class="nd">@get_insert_tuple</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">get_insert_tuple_pandas</span><span class="p">(</span><span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Create a list of tuples for insert when dataframe is pd.DataFrame.&quot;&quot;&quot;</span>
            <span class="n">to_insert</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">none_row</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="kc">None</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">row</span><span class="p">)</span>
                <span class="n">to_insert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">none_row</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">to_insert</span>

        <span class="nd">@get_insert_tuple</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">get_insert_tuple_polars</span><span class="p">(</span><span class="n">dataframe</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Create a list of tuples for insert when dataframe is pl.DataFrame.&quot;&quot;&quot;</span>
            <span class="n">to_insert</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dataframe</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">dataframe</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cs</span><span class="o">.</span><span class="n">numeric</span><span class="p">()</span><span class="o">.</span><span class="n">fill_nan</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">():</span>
                <span class="n">none_row</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="kc">None</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">row</span><span class="p">)</span>
                <span class="n">to_insert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">none_row</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">to_insert</span>

        <span class="c1"># create a list of tuples for insert</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">to_insert</span> <span class="o">=</span> <span class="n">get_insert_tuple</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;DataFrame to insert must either be a pandas.DataFrame or polars.DataFrame.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">create</span> <span class="ow">and</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Metadata will not be used because create is set to False.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metadata is missing. Generating metadata ...&quot;</span><span class="p">)</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">find_column_type</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="s2">&quot;snowflake&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metadata is complete. Creating new table ...&quot;</span><span class="p">)</span>

            <span class="n">create_join</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;(&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="nb">list</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="p">))</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="p">)</span>
            <span class="n">column_sql</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
            <span class="n">create_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CREATE TABLE </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">create_join</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">create_query</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New table has been created&quot;</span><span class="p">)</span>

        <span class="n">insert_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;INSERT INTO </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">column_sql</span><span class="si">}</span><span class="s2"> VALUES </span><span class="si">{</span><span class="n">string_join</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Inserting records...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_query</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">to_insert</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Table insertion has completed&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Snowflake.to_dataframe">
<a class="viewcode-back" href="../../api/locopy.snowflake.html#locopy.Snowflake.to_dataframe">[docs]</a>
    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_type</span><span class="o">=</span><span class="s2">&quot;pandas&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dataframe of the last query results.</span>

<span class="sd">        This is just a convenience method. This</span>
<span class="sd">        method overrides the base classes implementation in favour for the snowflake connectors</span>
<span class="sd">        built-in ``fetch_pandas_all`` when ``size==None``. If ``size != None`` then we will continue</span>
<span class="sd">        to use the existing functionality where we iterate through the cursor and build the</span>
<span class="sd">        dataframe.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df_type: Literal[&quot;pandas&quot;,&quot;polars&quot;], optional</span>
<span class="sd">            Output dataframe format. Defaults to pandas.</span>

<span class="sd">        size : int, optional</span>
<span class="sd">            Chunk size to fetch.  Defaults to None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame or polars.DataFrame</span>
<span class="sd">            Dataframe with lowercase column names.  Returns None if no fetched</span>
<span class="sd">            result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">df_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pandas&quot;</span><span class="p">,</span> <span class="s2">&quot;polars&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;df_type must be ``pandas`` or ``polars``.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">_query_result_format</span> <span class="o">==</span> <span class="s2">&quot;arrow&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">df_type</span> <span class="o">==</span> <span class="s2">&quot;pandas&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetch_pandas_all</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">df_type</span> <span class="o">==</span> <span class="s2">&quot;polars&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">from_arrow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetch_arrow_all</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">df_type</span><span class="o">=</span><span class="n">df_type</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, Capital One Services, LLC.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>